<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Member Registration</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="auth-page">
  <div class="auth-wrap">
    <div class="auth-card">
      <div class="brand">
        <div class="brand-text">
          <h1 class="brand-title">Sign up</h1>
          <p class="brand-subtitle">Create your account</p>
        </div>
      </div>

      <form id="signupForm" class="auth-form" autocomplete="on" novalidate>
        <div class="field">
          <label class="field-label" for="username">Name</label>
          <input
            class="input"
            type="text"
            id="username"
            placeholder="Your name"
            required
            autocomplete="name"
          />
          <div id="usernameErr" class="hint error"></div>
        </div>

        <div class="field">
          <label class="field-label" for="email">E-mail</label>
          <input
            class="input"
            type="email"
            id="email"
            placeholder="example@email.com"
            required
            autocomplete="email"
          />
          <div id="emailErr" class="hint error"></div>
        </div>

        <div class="field">
          <label class="field-label" for="password">Password</label>
          <input
            class="input"
            type="password"
            id="password"
            placeholder="••••••••"
            required
            autocomplete="new-password"
          />
          <div id="passwordErr" class="hint error"></div>
          <button type="button" class="field-icon" id="togglePwd" aria-label="Show password">Show</button>
        </div>

        <div class="field">
          <label class="field-label" for="confirmPassword">Confirm Password</label>
          <input
            class="input"
            type="password"
            id="confirmPassword"
            placeholder="••••••••"
            required
            autocomplete="new-password"
          />
          <div id="confirmErr" class="hint error"></div>
          <span id="pwdHint" class="hint"></span>
        </div>

        <div class="field">
          <label class="field-label" for="phone">Phone</label>
          <input
            class="input"
            type="tel"
            id="phone"
            placeholder="9912341234"
            autocomplete="tel"
          />
          <div id="phoneErr" class="hint error"></div>
        </div>
        
        <div id="status" class="status"></div>

        <button id="signupBtn" type="submit" class="btn btn-primary">Sign Up</button>
      </form>

      <div class="auth-links">
        <span class="muted">Already have an account?</span>
        <a class="link" href="/login">Sign in</a>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      setStatus, authApi, validatePassword, validateEmail,
      setLoading, validateUsername, validateIndianPhone
    } from '/app.js';

    const statusEl = document.getElementById('status');
    const form = document.getElementById('signupForm');
    const signupBtn = document.getElementById('signupBtn');

    const usernameEl = document.getElementById('username');
    const emailEl    = document.getElementById('email');
    const pwd        = document.getElementById('password');
    const cpwd       = document.getElementById('confirmPassword');
    const phoneEl    = document.getElementById('phone');
    const pwdHint    = document.getElementById('pwdHint');
    const togglePwd  = document.getElementById('togglePwd');

    // Inline error helpers
    const errs = {
      username: document.getElementById('usernameErr'),
      email:    document.getElementById('emailErr'),
      password: document.getElementById('passwordErr'),
      confirm:  document.getElementById('confirmErr'),
      phone:    document.getElementById('phoneErr')
    };
    function clearFieldErrors() {
      Object.values(errs).forEach(el => el && (el.textContent = ''));
    }
    function setFieldError(field, msg) {
      if (errs[field]) errs[field].textContent = msg || '';
    }

    // Show/Hide password (was missing)
    function togglePasswordVisibility() {
      const isPass = pwd.type === 'password';
      pwd.type = isPass ? 'text' : 'password';
      togglePwd.textContent = isPass ? 'Hide' : 'Show';
      togglePwd.setAttribute('aria-label', isPass ? 'Hide password' : 'Show password');
    }
    togglePwd.addEventListener('click', togglePasswordVisibility);

    // Password hint — show errors only after blur; while typing show nothing (or a positive match)
    let touchedPwd = false;
    let touchedConfirm = false;

    function showPwdHint(msg = '', ok = false) {
      if (!msg) {
        pwdHint.textContent = '';
        pwdHint.className = '';
      } else {
        pwdHint.textContent = msg;
        pwdHint.className = ok ? 'ok' : 'error';
      }
    }

    function validatePasswordsForHint({ live = false } = {}) {
      const password = pwd.value;
      const confirm  = cpwd.value;

      if (live) {
        // While typing, don't show errors; only show positive "match" once both filled and equal
        if (password && confirm && password === confirm) {
          showPwdHint('Passwords match', true);
        } else {
          showPwdHint('');
        }
        return;
      }

      // On blur (touched), now we can show policy/mismatch errors if present
      const { isValid, errors } = validatePassword(password, confirm);

      // If neither field has been touched yet, or both are empty, show nothing
      if ((!password && !confirm) || (!touchedPwd && !touchedConfirm)) {
        showPwdHint('');
        return;
      }

      if (isValid) {
        showPwdHint('Passwords match', true);
      } else {
        showPwdHint(errors[0], false); // show only the first relevant error
      }
    }

    // While typing: quiet (no errors), but show positive "match" if both equal
    pwd.addEventListener('input',  () => validatePasswordsForHint({ live: true }));
    cpwd.addEventListener('input', () => validatePasswordsForHint({ live: true }));
    // On blur: mark touched and allow errors to show
    pwd.addEventListener('blur',   () => { touchedPwd = true;     validatePasswordsForHint(); });
    cpwd.addEventListener('blur',  () => { touchedConfirm = true; validatePasswordsForHint(); });

    // Handle signup
    async function handleSignup(e) {
      e.preventDefault();
      clearFieldErrors();
      setStatus(statusEl, '');

      const username = usernameEl.value.trim();
      const email    = emailEl.value.trim();
      const password = pwd.value;
      const confirm  = cpwd.value;
      const phone    = phoneEl.value.trim();

      // Client-side validation (prevents hitting API with obvious issues)
      let hasError = false;

      const uVal = validateUsername(username);
      if (!uVal.isValid) { setFieldError('username', uVal.error); hasError = true; }

      const eVal = validateEmail(email);
      if (!eVal.isValid) { setFieldError('email', eVal.error); hasError = true; }

      const pVal = validatePassword(password, confirm);
      if (!pVal.isValid) {
        // Split errors between password and confirm messages if needed
        pVal.errors.forEach(msg => {
          if (msg.toLowerCase().includes('match')) setFieldError('confirm', msg);
          else setFieldError('password', msg);
        });
        hasError = true;
      }

      const phVal = validateIndianPhone(phone);
      if (!phVal.isValid) { setFieldError('phone', phVal.error); hasError = true; }


      if (hasError) return; // <-- stops API call when confirm is empty or invalid

      setLoading(signupBtn, true);
      try {
        const data = await authApi.register({ username, email, password, phone });
        // Use server message exactly as returned
        const msg = data?.message || 'Registered successfully.';
        setStatus(statusEl, msg, true);
        form.reset();
        pwdHint.textContent = '';
        setTimeout(() => {
          window.location.href = "/login";
        }, 1000);
      } catch (error) {
        // Top-level status
        setStatus(statusEl, error.message || 'Registration failed');

        // Field-level API errors
        const details = (error && error.details) || {};
        if (details.username) setFieldError('username', details.username);
        if (details.email)    setFieldError('email',    details.email);
        if (details.password) setFieldError('password', details.password);
        if (details.phone)    setFieldError('phone',    details.phone);
        // Some backends send confirm/confirmPassword:
        if (details.confirm || details.confirmPassword) {
          setFieldError('confirm', details.confirm || details.confirmPassword);
        }

        // If details were not provided, keep the generic message shown above.
      } finally {
        setLoading(signupBtn, false);
      }
    }

    form.addEventListener('submit', handleSignup);
  </script>
</body>
</html>
